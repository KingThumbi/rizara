{# ===========================
   Buyer Signing — Admin Actions
   =========================== #}

{% if document.status == "draft" %}
  <form method="POST"
        action="{{ url_for('admin.send_document_for_signing', document_id=document.id) }}"
        style="display:inline;">
    <button class="btn btn-primary" type="submit">
      {% if document.buyer_sign_token %}
        Regenerate signing link
      {% else %}
        Send for signing
      {% endif %}
    </button>
  </form>
{% endif %}

{# ===========================
   Buyer Signing — Details Panel
   =========================== #}

<div class="card" style="margin-top:14px;">
  <h3 style="margin:0 0 10px;">Buyer Signing</h3>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
    <div>
      <div class="muted" style="font-size:12px; font-weight:900;">Status</div>
      <div style="font-weight:900;">{{ document.status }}</div>
    </div>

    <div>
      <div class="muted" style="font-size:12px; font-weight:900;">Signed at</div>
      <div style="font-weight:900;">
        {% if document.buyer_signed_at %}
          {{ document.buyer_signed_at }}
        {% else %}
          <span class="muted">Not signed</span>
        {% endif %}
      </div>
    </div>

    <div>
      <div class="muted" style="font-size:12px; font-weight:900;">Signer name</div>
      <div style="font-weight:800;">
        {% if document.buyer_sign_name %}
          {{ document.buyer_sign_name }}
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </div>
    </div>

    <div>
      <div class="muted" style="font-size:12px; font-weight:900;">Signer email</div>
      <div style="font-weight:800;">
        {% if document.buyer_sign_email %}
          <a href="mailto:{{ document.buyer_sign_email }}">{{ document.buyer_sign_email }}</a>
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </div>
    </div>

    <div style="grid-column: 1 / -1;">
      <div class="muted" style="font-size:12px; font-weight:900;">Signer IP</div>
      <div style="font-weight:700;">
        {% if document.buyer_sign_ip %}
          <code>{{ document.buyer_sign_ip }}</code>
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </div>
    </div>

    <div style="grid-column: 1 / -1;">
      <div class="muted" style="font-size:12px; font-weight:900;">User agent</div>
      <div style="font-weight:700;">
        {% if document.buyer_sign_user_agent %}
          <code style="white-space:pre-wrap; word-break:break-word;">
            {{ document.buyer_sign_user_agent }}
          </code>
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </div>
    </div>
  </div>

  {% if document.buyer_sign_token %}
    <hr style="border:none; border-top:1px solid var(--border); margin:14px 0;" />

    <div class="muted" style="font-size:12px; font-weight:900; margin-bottom:6px;">
      Active signing link
    </div>

    {% set sign_url = request.host_url ~ 'sign/' ~ document.buyer_sign_token %}

    <code id="sign-link-{{ document.id }}"
          style="display:block; padding:10px 12px;
                 border:1px dashed var(--border);
                 border-radius:12px;
                 background:#f8f9ff;">
      {{ sign_url }}
    </code>

    <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
      <button type="button"
              class="btn btn-primary"
              style="padding:10px 12px;"
              onclick="copySigningLink('sign-link-{{ document.id }}', this)">
        Copy link
      </button>

      <span class="muted" style="font-size:12px;">
        Valid until:
        <strong>{{ document.buyer_sign_token_expires_at }}</strong>
      </span>
    </div>

  {% else %}
    <hr style="border:none; border-top:1px solid var(--border); margin:14px 0;" />
    <div class="muted" style="font-size:12px;">
      No active signing link yet.
      {% if document.status == "draft" %}
        Use <strong>Send for signing</strong> to generate one.
      {% endif %}
    </div>
  {% endif %}
</div>

{# ===========================
   Page Scripts
   =========================== #}

{% block scripts %}
  {{ super() }}
  <script>
    async function copySigningLink(codeId, btn) {
      const el = document.getElementById(codeId);
      if (!el) return;

      const text = (el.textContent || "").trim();
      if (!text) return;

      const original = btn.textContent;

      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.setAttribute("readonly", "");
          ta.style.position = "absolute";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }

        btn.textContent = "Copied!";
        btn.disabled = true;

        setTimeout(() => {
          btn.textContent = original;
          btn.disabled = false;
        }, 1200);
      } catch (e) {
        window.prompt("Copy this link:", text);
      }
    }
  </script>
{% endblock %}
