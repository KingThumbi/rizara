{# app/templates/dashboard.html #}
{% extends "layouts/base.html" %}

{% block title %}Rizara Dashboard{% endblock %}

{# IMPORTANT:
   - This file assumes layouts/base.html already includes the HTML <head>, Tailwind config,
     and likely a global navbar/footer.
   - If your base.html does NOT include navbar/footer, this template still works because
     it includes a dashboard-specific top bar + footer inside the body block.
#}

{% block body %}

  <!-- TOP BAR (Dashboard Context) -->
  <div class="bg-jungle text-white px-6 py-4 flex justify-between items-center shadow">
    <div class="flex items-center gap-4">
      <div class="text-2xl font-bold tracking-wide">Rizara Meats</div>
      <span class="hidden md:inline text-sm opacity-90">Operations Dashboard</span>
    </div>

    <div class="flex items-center gap-3">
      <!-- Logged in as + Change Password -->
      <div class="hidden lg:flex items-center gap-2 bg-white/10 border border-white/20 rounded px-3 py-2">
        <span class="text-sm opacity-90">Logged in as</span>
        <span class="text-sm font-semibold">{{ current_user.email }}</span>
        <span class="opacity-60">|</span>
        <a href="{{ url_for('auth.change_password') }}"
           class="text-sm font-semibold underline underline-offset-2 hover:opacity-90 transition">
          Change Password
        </a>
      </div>

      <!-- Users -->
      <a href="{{ url_for('auth.admin_list_users') }}"
         class="bg-white/10 border border-white/20 text-white font-semibold px-4 py-2 rounded hover:bg-white/15 transition">
        Users
      </a>

      <!-- Create user -->
      <a href="{{ url_for('auth.admin_create_user') }}"
         class="bg-gold text-jungle font-semibold px-4 py-2 rounded hover:bg-yellow-400 transition">
        + New User
      </a>

      <!-- Logout -->
      <a href="{{ url_for('auth.logout') }}"
         class="bg-white text-jungle font-semibold px-4 py-2 rounded hover:bg-gray-100 transition">
        Logout
      </a>
    </div>
  </div>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-6 py-8">

    <!-- PAGE TITLE -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-jungle">Operations Dashboard</h1>
      <p class="text-gray-600 mt-1">All admin tools and operational overview in one place.</p>

      <!-- Mobile / Small screen: Logged in as + Change Password -->
      <div class="mt-3 lg:hidden flex flex-wrap items-center gap-2 text-sm">
        <span class="text-gray-600">Logged in as</span>
        <span class="font-semibold text-gray-900">{{ current_user.email }}</span>
        <span class="text-gray-400">|</span>
        <a href="{{ url_for('auth.change_password') }}"
           class="font-semibold text-jungle hover:underline">
          Change Password
        </a>
      </div>
    </div>

    <!-- FLASH MESSAGES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6 space-y-3">
          {% for category, message in messages %}
            <div class="px-4 py-3 rounded-lg
              {% if category == 'success' %}
                bg-green-100 text-green-800
              {% elif category in ['danger', 'error'] %}
                bg-red-100 text-red-800
              {% elif category == 'warning' %}
                bg-yellow-100 text-yellow-800
              {% else %}
                bg-gray-100 text-gray-800
              {% endif %}
            ">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- KPI CARDS -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-10">

      <a href="{{ url_for('main.add_farmer') }}"
         class="bg-white rounded-xl shadow p-6 border-l-8 border-jungle hover:shadow-md transition block">
        <h3 class="text-gray-500 text-sm uppercase">Farmers</h3>
        <p class="text-3xl font-bold text-jungle mt-2">{{ stats.farmers or 0 }}</p>
        <p class="text-xs text-gray-500 mt-2">Add / manage farmers</p>
      </a>

      <a href="{{ url_for('main.animal_pipeline_view', animal_type='goat', status='on_farm') }}"
         class="bg-white rounded-xl shadow p-6 border-l-8 border-gold hover:shadow-md transition block">
        <h3 class="text-gray-500 text-sm uppercase">Goats Tracked</h3>
        <p class="text-3xl font-bold text-jungle mt-2">{{ stats.goats or 0 }}</p>
        <p class="text-xs text-gray-500 mt-2">View goat pipeline</p>
      </a>

      <a href="{{ url_for('main.animal_pipeline_view', animal_type='sheep', status='on_farm') }}"
         class="bg-white rounded-xl shadow p-6 border-l-8 border-jungleLight hover:shadow-md transition block">
        <h3 class="text-gray-500 text-sm uppercase">Sheep Tracked</h3>
        <p class="text-3xl font-bold text-jungle mt-2">{{ stats.sheep or 0 }}</p>
        <p class="text-xs text-gray-500 mt-2">View sheep pipeline</p>
      </a>

      <a href="{{ url_for('main.animal_pipeline_view', animal_type='cattle', status='on_farm') }}"
         class="bg-white rounded-xl shadow p-6 border-l-8 border-gray-400 hover:shadow-md transition block">
        <h3 class="text-gray-500 text-sm uppercase">Cattle Tracked</h3>
        <p class="text-3xl font-bold text-jungle mt-2">{{ stats.cattle or 0 }}</p>
        <p class="text-xs text-gray-500 mt-2">View cattle pipeline</p>
      </a>

      <div class="bg-white rounded-xl shadow p-6 border-l-8 border-purple-500">
        <h3 class="text-gray-500 text-sm uppercase">Aggregation Batches</h3>
        <p class="text-3xl font-bold text-jungle mt-2">{{ stats.aggregation_batches or 0 }}</p>
        <p class="text-xs text-gray-500 mt-2">Create via Quick Actions</p>
      </div>

      <div class="bg-white rounded-xl shadow p-6 border-l-8 border-indigo-500">
        <h3 class="text-gray-500 text-sm uppercase">Processing Batches</h3>
        <p class="text-3xl font-bold text-jungle mt-2">{{ stats.processing_batches or 0 }}</p>
        <p class="text-xs text-gray-500 mt-2">Continue in batch overview</p>
      </div>

    </section>

    <!-- HOW TO CONTINUE WORK (VERY IMPORTANT FOR ADMIN WORKFLOW) -->
    <section class="bg-white rounded-xl shadow p-6 mb-10">
      <h2 class="text-xl font-semibold text-jungle mb-2">Operational Workflow</h2>
      <p class="text-gray-600 text-sm mb-4">
        After creating a processing batch, continue work from the batch overview: record yield → record sale → generate invoice → PDF.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="rounded-lg border border-gray-200 p-4">
          <div class="text-xs uppercase text-gray-500">Step 1</div>
          <div class="font-semibold text-gray-900 mt-1">Aggregation</div>
          <div class="text-sm text-gray-600 mt-1">Move animals from on-farm → aggregated.</div>
        </div>
        <div class="rounded-lg border border-gray-200 p-4">
          <div class="text-xs uppercase text-gray-500">Step 2</div>
          <div class="font-semibold text-gray-900 mt-1">Processing</div>
          <div class="text-sm text-gray-600 mt-1">Create processing batch from aggregated animals.</div>
        </div>
        <div class="rounded-lg border border-gray-200 p-4">
          <div class="text-xs uppercase text-gray-500">Step 3</div>
          <div class="font-semibold text-gray-900 mt-1">Yield</div>
          <div class="text-sm text-gray-600 mt-1">Record carcass weight and parts notes.</div>
        </div>
        <div class="rounded-lg border border-gray-200 p-4">
          <div class="text-xs uppercase text-gray-500">Step 4</div>
          <div class="font-semibold text-gray-900 mt-1">Sale & Invoice</div>
          <div class="text-sm text-gray-600 mt-1">Record sale → generate invoice → PDF.</div>
        </div>
      </div>
    </section>

    <!-- QUICK ACTIONS (Create) -->
    <section class="bg-white rounded-xl shadow p-6 mb-10">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h2 class="text-xl font-semibold text-jungle">Quick Actions</h2>
        <div class="text-sm text-gray-500">Create / register / start a workflow</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

        <a href="{{ url_for('main.add_farmer') }}"
           class="flex justify-center items-center bg-jungle text-white py-4 rounded-lg font-semibold hover:bg-jungleLight transition">
          + Add Farmer
        </a>

        <a href="{{ url_for('main.add_goat') }}"
           class="flex justify-center items-center bg-gold text-jungle py-4 rounded-lg font-semibold hover:bg-yellow-400 transition">
          + Register Goat
        </a>

        <a href="{{ url_for('main.add_sheep') }}"
           class="flex justify-center items-center bg-purple-500 text-white py-4 rounded-lg font-semibold hover:bg-purple-400 transition">
          + Register Sheep
        </a>

        <a href="{{ url_for('main.add_cattle') }}"
           class="flex justify-center items-center bg-indigo-500 text-white py-4 rounded-lg font-semibold hover:bg-indigo-400 transition">
          + Register Cattle
        </a>

        <!-- Aggregation -->
        <a href="{{ url_for('main.add_goat_aggregation') }}"
           class="flex justify-center items-center bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-500 transition">
          + Goat Aggregation Batch
        </a>

        <a href="{{ url_for('main.add_sheep_aggregation') }}"
           class="flex justify-center items-center bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-500 transition">
          + Sheep Aggregation Batch
        </a>

        <a href="{{ url_for('main.add_cattle_aggregation') }}"
           class="flex justify-center items-center bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-500 transition">
          + Cattle Aggregation Batch
        </a>

        <!-- Processing -->
        <a href="{{ url_for('main.add_goat_processing') }}"
           class="flex justify-center items-center bg-orange-600 text-white py-4 rounded-lg font-semibold hover:bg-orange-500 transition">
          + Goat Processing Batch
        </a>

        <a href="{{ url_for('main.add_sheep_processing') }}"
           class="flex justify-center items-center bg-orange-600 text-white py-4 rounded-lg font-semibold hover:bg-orange-500 transition">
          + Sheep Processing Batch
        </a>

        <a href="{{ url_for('main.add_cattle_processing') }}"
           class="flex justify-center items-center bg-orange-600 text-white py-4 rounded-lg font-semibold hover:bg-orange-500 transition">
          + Cattle Processing Batch
        </a>

        <!-- Users -->
        <a href="{{ url_for('auth.admin_list_users') }}"
           class="flex justify-center items-center bg-gray-900 text-white py-4 rounded-lg font-semibold hover:bg-gray-700 transition">
          Users (List / Search)
        </a>

        <a href="{{ url_for('auth.admin_create_user') }}"
           class="flex justify-center items-center bg-gray-800 text-white py-4 rounded-lg font-semibold hover:bg-gray-700 transition">
          + Create User
        </a>

        <!-- Documents -->
        <a href="{{ url_for('admin.documents_list') }}"
           class="flex justify-center items-center bg-jungle text-white py-4 rounded-lg font-semibold hover:bg-jungleLight transition">
          Documents
        </a>

        <a href="{{ url_for('admin.documents_new') }}"
           class="flex justify-center items-center bg-gold text-jungle py-4 rounded-lg font-semibold hover:bg-yellow-400 transition">
          + New Document
        </a>

        <!-- Buyers -->
        <a href="{{ url_for('admin.buyers_list') }}"
           class="flex justify-center items-center bg-gray-900 text-white py-4 rounded-lg font-semibold hover:bg-gray-700 transition">
          Buyers
        </a>

        <a href="{{ url_for('admin.buyers_new') }}"
           class="flex justify-center items-center bg-gray-800 text-white py-4 rounded-lg font-semibold hover:bg-gray-700 transition">
          + New Buyer
        </a>

      </div>
    </section>

    <!-- ADMIN SECTIONS (Operations inbox) -->
    <section class="bg-white rounded-xl shadow p-6 mb-10">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h2 class="text-xl font-semibold text-jungle">Admin Inbox</h2>
        <div class="text-sm text-gray-500">Review inbound requests</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <a href="{{ url_for('main.contact_messages') }}"
           class="flex justify-center items-center bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-500 transition">
          Contact Messages
        </a>

        <a href="{{ url_for('main.order_requests') }}"
           class="flex justify-center items-center bg-green-600 text-white py-4 rounded-lg font-semibold hover:bg-green-500 transition">
          Order Requests
        </a>

      </div>
    </section>

    <!-- ANIMAL STATUS PIPELINE -->
    {% for animal, pipeline in [('goat', goat_pipeline), ('sheep', sheep_pipeline), ('cattle', cattle_pipeline)] %}
    <section class="bg-white rounded-xl shadow p-6 mb-10">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h2 class="text-xl font-semibold text-jungle">{{ animal.capitalize() }} Pipeline</h2>
        <div class="text-sm text-gray-500">Click a status to view records</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        {% for status, color in [('on_farm','green'), ('aggregated','blue'), ('processing','orange'), ('processed','yellow'), ('sold','red')] %}
          <a href="{{ url_for('main.animal_pipeline_view', animal_type=animal, status=status) }}"
             class="block bg-{{ color }}-100 rounded-lg p-4 text-center hover:bg-{{ color }}-200 transition">
            <h3 class="text-sm text-gray-600 uppercase">{{ status.replace('_',' ').capitalize() }}</h3>
            <p class="text-2xl font-bold text-{{ color }}-700">{{ pipeline[status] or 0 }}</p>
          </a>
        {% endfor %}
      </div>
    </section>
    {% endfor %}

    <!-- RECENT CONTACTS & ORDERS -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">

      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold text-jungle">Recent Contact Messages</h2>
          <a class="text-sm text-jungle hover:underline" href="{{ url_for('main.contact_messages') }}">View all</a>
        </div>

        {% if stats.latest_contacts %}
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="py-2 text-left">Name</th>
                <th class="text-left">Email</th>
                <th class="text-left">Received</th>
              </tr>
            </thead>
            <tbody>
              {% for msg in stats.latest_contacts %}
              <tr class="border-b hover:bg-gray-50">
                <td class="py-2">{{ msg.name }}</td>
                <td>{{ msg.email }}</td>
                <td>{{ msg.created_at.strftime('%Y-%m-%d') if msg.created_at else '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-gray-500 text-sm">No contact messages yet.</p>
        {% endif %}
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold text-jungle">Recent Order Requests</h2>
          <a class="text-sm text-jungle hover:underline" href="{{ url_for('main.order_requests') }}">View all</a>
        </div>

        {% if stats.latest_orders %}
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="py-2 text-left">Buyer</th>
                <th class="text-left">Product</th>
                <th class="text-left">Qty</th>
                <th class="text-left">Received</th>
              </tr>
            </thead>
            <tbody>
              {% for order in stats.latest_orders %}
              <tr class="border-b hover:bg-gray-50">
                <td class="py-2">{{ order.buyer_name }}</td>
                <td>{{ order.product }}</td>
                <td>{{ order.quantity }}</td>
                <td>{{ order.created_at.strftime('%Y-%m-%d') if order.created_at else '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-gray-500 text-sm">No order requests yet.</p>
        {% endif %}
      </div>

    </section>

  </main>

  <!-- FOOTER -->
  <footer class="text-center text-sm text-gray-500 py-6">
    © {{ current_year or 2026 }} Rizara Meats Ltd — Ethical • Traceable • Halal
  </footer>

{% endblock %}
