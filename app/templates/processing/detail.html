{# /home/thumbi/rizara/app/templates/processing/detail.html #}
{% extends "layouts/base.html" %}

{% block title %}Processing Batch #{{ batch.id }} | Rizara{% endblock %}

{% block head %}
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            jungle: '#1f6f54',
            jungleLight: '#2f8f6b',
            gold: '#d4af37',
            grayDark: '#1f2937'
          }
        }
      }
    }
  </script>
{% endblock %}

{% block body %}

  <!-- Navbar -->
  <nav class="bg-jungle text-white px-6 py-4 flex justify-between items-center shadow">
    <div class="text-xl font-bold tracking-wide">Rizara Meats</div>
    <div class="flex items-center gap-3">
      <a href="{{ url_for('main.processing_list') }}"
         class="bg-gold text-jungle font-semibold px-4 py-2 rounded hover:bg-yellow-400 transition">
        ← Back to Processing
      </a>
      <a href="{{ url_for('main.dashboard') }}"
         class="bg-white/10 text-white font-semibold px-4 py-2 rounded hover:bg-white/20 transition">
        Dashboard
      </a>
      <a href="{{ url_for('auth.logout') }}"
         class="bg-white/10 text-white font-semibold px-4 py-2 rounded hover:bg-white/20 transition">
        Logout
      </a>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-6 py-10">

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-jungle">Processing Batch #{{ batch.id }}</h1>
      <p class="text-gray-600 mt-1">
        {{ batch.animal_type|capitalize }} • Facility: <b>{{ batch.facility }}</b>
        {% if batch.slaughter_date %} • Slaughter Date: <b>{{ batch.slaughter_date }}</b>{% endif %}
      </p>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6 space-y-3">
          {% for category, message in messages %}
            <div class="px-4 py-3 rounded-lg
              {% if category == 'success' %}
                bg-green-100 text-green-800
              {% elif category in ['danger', 'error'] %}
                bg-red-100 text-red-800
              {% else %}
                bg-gray-100 text-gray-800
              {% endif %}
            ">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Batch Info -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow p-6 space-y-4">
          <h2 class="text-lg font-bold text-gray-900">Batch Details</h2>

          <div class="text-sm text-gray-700 space-y-2">
            <p><span class="font-semibold">Animal Type:</span> {{ batch.animal_type|capitalize }}</p>
            <p><span class="font-semibold">Facility:</span> {{ batch.facility }}</p>
            <p><span class="font-semibold">Slaughter Date:</span> {{ batch.slaughter_date if batch.slaughter_date else '-' }}</p>
            <p><span class="font-semibold">Halal Certificate:</span> {{ batch.halal_cert_ref if batch.halal_cert_ref else '-' }}</p>
            <p class="pt-2">
              {% if batch.is_locked %}
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-gray-200 text-gray-800 text-xs font-semibold">
                  Locked
                </span>
              {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-800 text-xs font-semibold">
                  Open
                </span>
              {% endif %}
            </p>
          </div>

          <div class="pt-2 flex flex-wrap gap-3">
            <a href="{{ url_for('main.view_invoiceable_batch', batch_id=batch.id) }}"
               class="px-4 py-2 rounded-lg bg-jungle text-white text-sm font-semibold hover:bg-jungleLight transition">
              Open Overview
            </a>
          </div>
        </div>
      </div>

      <!-- Animals in Batch -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
            <div>
              <h2 class="text-lg font-bold text-gray-900">Animals in this Batch</h2>
              <p class="text-sm text-gray-600">
                Showing animals attached to processing batch #{{ batch.id }}.
              </p>
            </div>

            <div class="text-sm text-gray-700">
              {% if batch.animal_type == 'goat' %}
                <b>{{ batch.goats|length }}</b> goats
              {% elif batch.animal_type == 'sheep' %}
                <b>{{ batch.sheep|length }}</b> sheep
              {% elif batch.animal_type == 'cattle' %}
                <b>{{ batch.cattle|length }}</b> cattle
              {% else %}
                —
              {% endif %}
            </div>
          </div>

          {% set animals = [] %}
          {% if batch.animal_type == 'goat' %}
            {% set animals = batch.goats %}
          {% elif batch.animal_type == 'sheep' %}
            {% set animals = batch.sheep %}
          {% elif batch.animal_type == 'cattle' %}
            {% set animals = batch.cattle %}
          {% endif %}

          {% if not animals %}
            <div class="p-6">
              <div class="bg-gray-50 border border-gray-200 text-gray-700 px-4 py-3 rounded-lg">
                No animals found in this processing batch.
              </div>
            </div>
          {% else %}
            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 sticky top-0">
                  <tr class="text-left text-gray-700">
                    <th class="p-4">Rizara ID</th>
                    <th class="p-4">Farmer</th>
                    <th class="p-4">Sex</th>
                    <th class="p-4">Breed</th>
                    <th class="p-4">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for a in animals %}
                    <tr class="border-t hover:bg-gray-50">
                      <td class="p-4 font-semibold text-gray-900">{{ a.rizara_id }}</td>
                      <td class="p-4 text-gray-700">{{ a.farmer_tag or (a.farmer.name if a.farmer else '-') }}</td>
                      <td class="p-4 text-gray-700">{{ a.sex or '-' }}</td>
                      <td class="p-4 text-gray-700">{{ a.breed or '-' }}</td>
                      <td class="p-4">
                        <span class="px-3 py-1 rounded-full bg-gray-100 text-gray-800 text-xs font-semibold">
                          {{ a.status }}
                        </span>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>

    </div>

  </main>

  <footer class="text-center text-sm text-gray-500 py-6">
    © {{ current_year or 2026 }} Rizara Meats Ltd — Secure • Traceable • Halal
  </footer>

{% endblock %}
