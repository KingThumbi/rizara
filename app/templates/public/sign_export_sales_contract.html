{# app/templates/public/sign_export_sales_contract.html #}
{% extends "layouts/base.html" %}
{% block title %}Sign Contract · Rizara{% endblock %}

{% block body %}
  {% set p = document.payload or {} %}
  {% set contract = p.get('contract', {}) %}
  {% set product  = p.get('product', {}) %}
  {% set pricing  = p.get('pricing', {}) %}
  {% set payment  = p.get('payment', {}) %}

  {# TOP BAR (Public Context) — matches dashboard style #}
  <div class="bg-jungle text-white px-6 py-4 flex justify-between items-center shadow">
    <div class="flex items-center gap-4">
      <div class="text-2xl font-bold tracking-wide">Rizara Meats</div>
      <span class="hidden md:inline text-sm opacity-90">Buyer Signing Portal</span>
    </div>

    <div class="flex items-center gap-3">
      <a href="{{ url_for('main.public_download_contract_draft_pdf', token=token) }}"
         target="_blank" rel="noopener"
         class="bg-gold text-jungle font-semibold px-4 py-2 rounded hover:bg-yellow-400 transition">
        View Draft PDF
      </a>

      <a href="#sign"
         class="bg-white text-jungle font-semibold px-4 py-2 rounded hover:bg-gray-100 transition">
        Sign Now
      </a>
    </div>
  </div>

  {# MAIN — match dashboard container sizing #}
  <main class="max-w-7xl mx-auto px-6 py-8">

    {# PAGE TITLE — match dashboard typography #}
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-jungle">Export Sales Contract</h1>
      <p class="text-gray-600 mt-1">
        Please review the draft PDF first. If anything is incorrect, request changes before signing.
      </p>

      <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
        <span class="text-gray-600">Document ID</span>
        <span class="font-mono text-gray-900">{{ document.id }}</span>
        <span class="text-gray-400">|</span>
        <span class="text-gray-600">Version</span>
        <span class="font-semibold text-gray-900">v{{ document.version }}</span>
        <span class="text-gray-400">|</span>
        <span class="text-gray-600">Date (EAT)</span>
        <span class="font-mono text-gray-900">{{ now_eat }}</span>
      </div>
    </div>

    {# FLASH MESSAGES — match dashboard flash styles #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6 space-y-3">
          {% for category, message in messages %}
            <div class="px-4 py-3 rounded-lg
              {% if category == 'success' %}
                bg-green-100 text-green-800
              {% elif category in ['danger', 'error'] %}
                bg-red-100 text-red-800
              {% elif category == 'warning' %}
                bg-yellow-100 text-yellow-800
              {% else %}
                bg-gray-100 text-gray-800
              {% endif %}
            ">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {# CONTENT GRID — dashboard-like cards #}
    <section class="grid grid-cols-1 lg:grid-cols-5 gap-6">

      {# LEFT COLUMN — summary card #}
      <aside class="lg:col-span-2">

        <div class="bg-white rounded-xl shadow p-6 mb-6">
          <h2 class="text-xl font-semibold text-jungle mb-2">Contract Summary</h2>
          <p class="text-gray-600 text-sm mb-4">
            Key terms below are a quick reference. Always rely on the PDF as the source of truth.
          </p>

          <div class="space-y-3 text-sm">
            <div class="flex items-start justify-between gap-4">
              <span class="text-gray-600">Incoterm</span>
              <span class="font-semibold text-gray-900 text-right">{{ contract.get('incoterm','—') }}</span>
            </div>
            <div class="flex items-start justify-between gap-4">
              <span class="text-gray-600">Quantity (kg)</span>
              <span class="font-semibold text-gray-900 text-right">{{ product.get('quantity_kg','—') }}</span>
            </div>
            <div class="flex items-start justify-between gap-4">
              <span class="text-gray-600">Price / kg</span>
              <span class="font-semibold text-gray-900 text-right">{{ pricing.get('price_per_kg','—') }}</span>
            </div>

            <div class="pt-3 mt-3 border-t border-gray-200">
              <div class="text-gray-600">Payment</div>
              <div class="mt-1 font-semibold text-gray-900">
                {{ payment.get('advance_percent','—') }}% advance
                <span class="text-gray-400 mx-1">/</span>
                {{ payment.get('balance_percent','—') }}% balance
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <h2 class="text-xl font-semibold text-jungle mb-2">Important</h2>
          <ul class="text-sm text-gray-600 space-y-2">
            <li>• This signing link is private — do not share it.</li>
            <li>• If you need changes, do not sign yet. Request an updated draft.</li>
            <li>• Your typed name will be stored as the signature for this version.</li>
          </ul>

          <div class="mt-5">
            <a href="{{ url_for('main.public_download_contract_draft_pdf', token=token) }}"
               target="_blank" rel="noopener"
               class="w-full flex justify-center items-center bg-gold text-jungle py-3 rounded-lg font-semibold hover:bg-yellow-400 transition">
              View Draft PDF
            </a>
          </div>
        </div>

      </aside>

      {# RIGHT COLUMN — signing form card #}
      <section class="lg:col-span-3">

        <div id="sign" class="bg-white rounded-xl shadow p-6">
          <div class="flex items-center justify-between gap-4 mb-4">
            <h2 class="text-xl font-semibold text-jungle">Sign Contract</h2>
            <div class="text-sm text-gray-500">Secure digital signing</div>
          </div>

          <form method="POST" action="/sign/{{ token }}" class="space-y-5">
            <div>
              <label class="block text-sm font-semibold text-gray-900 mb-1">Your full name</label>
              <input
                name="signer_name"
                required
                autocomplete="name"
                class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jungle/30"
                placeholder="e.g. Ahmed Ali"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-900 mb-1">Email (optional)</label>
              <input
                name="signer_email"
                type="email"
                autocomplete="email"
                class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jungle/30"
                placeholder="e.g. buyer@company.com"
              />
              <p class="mt-1 text-xs text-gray-500">If provided, it will be included in the signing record.</p>
            </div>

            <div class="rounded-lg border border-gray-200 bg-gray-50 p-4">
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  name="consent"
                  value="yes"
                  class="mt-1 h-4 w-4 rounded border-gray-300"
                  required
                >
                <div class="text-sm text-gray-700">
                  <div class="font-semibold text-gray-900">Consent to sign electronically</div>
                  <p class="mt-1 text-gray-600">
                    I confirm I have reviewed the contract PDF and agree to the terms.
                    I understand my typed name serves as my electronic signature.
                  </p>
                </div>
              </div>
            </div>

            <button
              type="submit"
              class="w-full flex justify-center items-center bg-jungle text-white py-3 rounded-lg font-semibold hover:bg-jungleLight transition">
              Sign Contract
            </button>

            <div class="text-center text-xs text-gray-500">
              By signing, you agree to electronic records and typed-name signing for this transaction.
            </div>
          </form>
        </div>

        <div class="bg-white rounded-xl shadow p-6 mt-6">
          <h3 class="text-lg font-semibold text-jungle mb-2">Signing Record</h3>
          <p class="text-sm text-gray-600">
            Your signing details will be stored with the contract version shown above.
            If the contract is revised, you’ll receive a new signing link for the updated version.
          </p>
        </div>

      </section>
    </section>

  </main>

  {# FOOTER — same as dashboard style #}
  <footer class="text-center text-sm text-gray-500 py-6">
    © {{ now_eat.year }} Rizara Meats Ltd — Ethical • Traceable • Halal
  </footer>

{% endblock %}