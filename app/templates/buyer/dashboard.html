{% extends "layouts/base.html" %}

{% block title %}Buyer Dashboard | Rizara{% endblock %}

{% block body %}

<nav class="bg-jungle text-white px-6 py-4 flex justify-between items-center shadow">
  <div class="text-xl font-bold tracking-wide">Rizara Meats</div>
  <div class="flex items-center gap-3">
    <span class="text-sm opacity-90">Buyer Portal</span>
    <a href="{{ url_for('auth.logout') }}"
       class="bg-gold text-jungle font-semibold px-4 py-2 rounded hover:bg-yellow-400 transition">
      Logout
    </a>
  </div>
</nav>

<main class="max-w-6xl mx-auto px-6 py-10">

  <div class="mb-8 flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-jungle">Welcome, {{ buyer.name }}</h1>
      <p class="text-gray-600 mt-1">Your purchase history, invoices, and repeat orders.</p>
    </div>

    <a href="{{ url_for('main.buyer_new_order') }}"
       class="inline-flex items-center px-5 py-2 rounded-lg bg-gold text-jungle font-semibold hover:bg-yellow-400 transition">
      + New Order
    </a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-3">
        {% for category, message in messages %}
          <div class="px-4 py-3 rounded-lg
            {% if category == 'success' %}
              bg-green-100 text-green-800
            {% elif category in ['danger', 'error'] %}
              bg-red-100 text-red-800
            {% else %}
              bg-gray-100 text-gray-800
            {% endif %}
          ">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="bg-white rounded-xl shadow p-6">
    <h2 class="text-xl font-semibold text-jungle mb-4">Purchase History</h2>

    {% if sales %}
      <div class="overflow-x-auto">
        <table class="w-full text-sm border border-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-3 text-left font-semibold text-gray-700">Sale Date</th>
              <th class="p-3 text-left font-semibold text-gray-700">Batch</th>
              <th class="p-3 text-left font-semibold text-gray-700">Total</th>
              <th class="p-3 text-left font-semibold text-gray-700">Invoice</th>
              <th class="p-3 text-left font-semibold text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sales %}
              {% set inv = invoice_map.get(s.id) %}
              <tr class="border-t">
                <td class="p-3">{{ s.sale_date }}</td>
                <td class="p-3">#{{ s.processing_batch_id }}</td>
                <td class="p-3">{{ s.total_sale_price }} {{ s.currency or 'KES' }}</td>

                <td class="p-3">
                  {% if inv %}
                    <span class="font-semibold">{{ inv.invoice_number }}</span>
                  {% else %}
                    <span class="text-gray-500">Not issued yet</span>
                  {% endif %}
                </td>

                <td class="p-3">
                  {% if inv %}
                    <div class="flex flex-wrap gap-2">
                      <a href="{{ url_for('main.buyer_view_invoice', invoice_id=inv.id) }}"
                         class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition">
                        View
                      </a>
                      <a href="{{ url_for('main.buyer_invoice_pdf', invoice_id=inv.id) }}"
                         target="_blank" rel="noopener"
                         class="px-3 py-2 rounded-lg bg-jungle text-white font-semibold hover:bg-jungleLight transition">
                        Open PDF
                      </a>
                    </div>
                  {% else %}
                    <span class="text-gray-500">—</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-gray-600">No purchases found yet.</p>
    {% endif %}
  </div>

</main>

<footer class="text-center text-sm text-gray-500 py-6">
  © {{ current_year or 2026 }} Rizara Meats Ltd — Secure • Traceable • Halal
</footer>

{% endblock %}
